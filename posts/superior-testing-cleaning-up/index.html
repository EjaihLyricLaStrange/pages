<!DOCTYPE html>
<html lang="en-us">
<head>
  <title>Superior Testing: Cleaning Up</title>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link rel="stylesheet" href="/css/style.css" />
  <link rel="stylesheet" href="/css/syntax-highlighting.css" />

  
  <meta name="theme-color" content="#1e2327">

  <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Superior Testing: Cleaning Up"/>
<meta name="twitter:description" content="Making the world a better place, one byte at a time."/>
<meta name="twitter:site" content="@arturdryomov"/>

</head>

<body>


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-112239048-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>


<header>
<nav>
  <ul>
    
    <li class="menu-left"><a href="/">Posts</a></li>
    
    
    <li class="menu-right"><a href="/index.xml">RSS</a></li>
    
    <li class="menu-right"><a href="https://twitter.com/arturdryomov">Twitter</a></li>
    
    <li class="menu-right"><a href="https://github.com/arturdryomov">GitHub</a></li>
    
  </ul>
</nav>

</header>

<br/>


<div class="meta">

  <h1><span class="title">Superior Testing: Cleaning Up</span></h1>
  <h3>June 6, 2019</h3>

</div>

<main>
<p>There is a game called <a href="https://en.wikipedia.org/wiki/Viscera_Cleanup_Detail">Viscera Cleanup Detail</a>.
The task in this game is to&hellip; clean things up.
Well, it is a bit more exciting since it involves alien invasions,
but at the end of the day players become space janitors.
It is surprisingly addictive.</p>
<p>Cleaning things is useful and helpful in a lot of ways.
Developers understand that, but usually there is an additional motivation
to keep things in order — users.
Nobody wants a product that breaks because there is not enough memory
or wrecks havoc across the file system.
The picture is very different with tests — often they become
a second class citizen. It shouldn’t be this way.</p>
<h1 id="ram">RAM</h1>
<p>It is interesting that not a lot of people bother with memory management
in tests. Tests run so fast and have such
short lifecycle that memory consumption doesn’t seem like an issue.
At the same time this short time-to-live cycle hits garbage collector hard.
And guess what works worse when there are memory leaks but
the execution demands more and more memory? That’s right — GC.
In practice it means that memory leaks and high memory consumption in general
slow down test runs, eventually leading to out-of-memory errors.</p>
<h2 id="mockito">Mockito</h2>
<h3 id="inline-mocking">Inline Mocking</h3>
<p>Mockito 2.1.0 introduced <a href="https://github.com/mockito/mockito/wiki/What%27s-new-in-Mockito-2#mock-the-unmockable-opt-in-mocking-of-final-classesmethods">inline mocking</a>.
It allows to mock and spy <code>final</code> Java classes.
This might be useful in combination with Kotlin, where classes are <code>final</code> by default.
Unfortunately this mechanism <a href="https://github.com/mockito/mockito/issues/1614">doesn’t work well with cyclic references</a>.
At the same time the issue is so tricky <a href="https://static.javadoc.io/org.mockito/mockito-core/2.27.0/org/mockito/MockitoFramework.html#clearInlineMocks--">a new API</a>
was introduced to mitigate this since it was not possible to resolve it automatically.
Use it!</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="nd">@After</span> <span class="k">fun</span> <span class="nf">clearMockito</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">Mockito</span><span class="p">.</span><span class="n">framework</span><span class="p">().</span><span class="n">clearInlineMocks</span><span class="p">()</span>
<span class="p">}</span>
</code></pre></div><h3 id="stubs">Stubs</h3>
<p>It might be surprising to find out how much Mockito does under the hood.
There is basically a mini-GC tracking all invocations.
Fortunately we can save a bit of memory using
<a href="https://static.javadoc.io/org.mockito/mockito-core/2.27.0/org/mockito/MockSettings.html#stubOnly--">a not very popular method to create stubs</a>
which do not track invocations.
Use it to make dumb objects which will not be verified in the future.
Or not use Mockito at all for this, just create objects by hand.</p>
<p>We can make a handy Kotlin function which will reduce the boilerplate.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="k">inline</span> <span class="k">fun</span> <span class="p">&lt;</span><span class="k">reified</span> <span class="nc">T</span> <span class="p">:</span> <span class="nc">Any</span><span class="p">&gt;</span> <span class="nf">stub</span><span class="p">()</span> <span class="p">=</span> <span class="n">Mockito</span><span class="p">.</span><span class="n">mock</span><span class="p">(</span><span class="n">T</span><span class="o">::</span><span class="k">class</span><span class="p">.</span><span class="n">java</span><span class="p">,</span> <span class="n">Mockito</span><span class="p">.</span><span class="n">withSettings</span><span class="p">().</span><span class="n">stubOnly</span><span class="p">())</span> <span class="k">as</span> <span class="n">T</span>
</code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="k">val</span> <span class="py">actionStub</span> <span class="p">=</span> <span class="n">stub</span><span class="p">&lt;</span><span class="n">Action</span><span class="p">&gt;()</span>
</code></pre></div><h1 id="files">Files</h1>
<p>Dealing with files in tests is straightforward.</p>
<ul>
<li>Create files only in <a href="https://en.wikipedia.org/wiki/Temporary_folder">temporary directories</a>.</li>
<li>Delete files after each run.</li>
</ul>
<p>Not following these rules might result in myriads of files
scattered around in the project directory.
Especially if there are hundreds of them created and removed on each run.</p>
<p>Even better — do not repeat all necessary steps in all tests and
use <a href="https://junit.org/junit4/javadoc/latest/org/junit/rules/TemporaryFolder.html">a JUnit rule</a>
instead. It is not even necessary to use JUnit 4 to use it.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="k">val</span> <span class="py">fileSystem</span> <span class="k">by</span> <span class="n">memoized</span> <span class="p">{</span> <span class="n">TemporaryFolder</span><span class="p">()</span> <span class="p">}</span>

<span class="n">beforeEach</span> <span class="p">{</span>
    <span class="n">fileSystem</span><span class="p">.</span><span class="n">create</span><span class="p">()</span>
<span class="p">}</span>

<span class="k">it</span><span class="p">(</span><span class="s2">&#34;creates file system&#34;</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">assertThat</span><span class="p">(</span><span class="n">fileSystem</span><span class="p">.</span><span class="n">root</span><span class="p">).</span><span class="n">exists</span><span class="p">()</span>
<span class="p">}</span>

<span class="n">afterEach</span> <span class="p">{</span>
    <span class="n">fileSystem</span><span class="p">.</span><span class="n">delete</span><span class="p">()</span>
<span class="p">}</span>
</code></pre></div><h1 id="cleaning-up">Cleaning Up</h1>
<p>Think about test runs this way — they should not leave anything behind.
Tests are ghosts. Or ninjas.
And seriously — <a href="https://en.wikipedia.org/wiki/Viscera_Cleanup_Detail">play the game</a>.</p>

</main>


<hr/>

<footer>
<nav>
  <ul>
    
    <li class="menu-left"><a href="/">Posts</a></li>
    
    
    <li class="menu-right"><a href="/index.xml">RSS</a></li>
    
    <li class="menu-right"><a href="https://twitter.com/arturdryomov">Twitter</a></li>
    
    <li class="menu-right"><a href="https://github.com/arturdryomov">GitHub</a></li>
    
  </ul>
</nav>

</footer>


</body>

</html>

