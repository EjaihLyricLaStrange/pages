<!DOCTYPE html>
<html lang="en-us">
<head>
  <title>Kotlin Code Organization</title>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link rel="stylesheet" href="/css/style.css" />
  <link rel="stylesheet" href="/css/syntax-highlighting.css" />

  
  <meta name="theme-color" content="#1e2327">
</head>

<body>

<header>
<nav>
  <ul>
    
    <li class="menu-left"><a href="/">Posts</a></li>
    
    
    <li class="menu-right"><a href="/index.xml">RSS</a></li>
    
    <li class="menu-right"><a href="https://github.com/arturdryomov">GitHub</a></li>
    
  </ul>
</nav>

</header>

<br/>


<div class="meta">

  <h1><span class="title">Kotlin Code Organization</span></h1>
  <h3>January 27, 2020</h3>

</div>

<main>
<p>What’s the motivation behind organizing the code? Two points come to mind.</p>
<ul>
<li>Help humans. Consistent environments are easier to understand and adapt.
Storing the source code in <code>src/</code> instead of <code>_k_/</code> makes it easier to find.</li>
<li>Help machines. Build systems need hints. The code in <code>main/</code> should be
assembled all the time, while <code>test/</code> is test-specific and shouldn’t make it
to a production environment.</li>
</ul>
<p>Sounds empathic. Where do we start?</p>
<h1 id="sdl">SDL</h1>
<p>Maven introduced a concept of <a href="https://maven.apache.org/guides/introduction/introduction-to-the-standard-directory-layout.html">the Standard Directory Layout</a>.
Gradle <a href="https://docs.gradle.org/current/userguide/organizing_gradle_projects.html">tends to follow it</a>
bringing so-called <a href="https://docs.gradle.org/current/userguide/building_java_projects.html#sec:java_source_sets">source sets</a>
along the way. The following file system tree is SDL-compliant.</p>
<pre tabindex="0"><code>.
├── main
│   ├── java
│   │   └── Code.java
│   ├── kotlin
│   │   └── Kode.kt
│   └── resources
│       └── production.xml
└── test
    ├── java
    │   └── CodeTests.java
    ├── kotlin
    │   └── KodeTests.kt
    └── resources
        └── test.xml
</code></pre><ul>
<li><code>main</code>, <code>test</code> — source sets. Include everything related to the code scope —
like the production application (<code>main</code>), unit tests (<code>test</code>) and more
(<code>androidTest</code> and friends).</li>
<li><code>java</code>, <code>kotlin</code>, <code>resources</code> — source set implementation details.
Unit tests can be written in Kotlin and Groovy at the same time,
the production code might be a Java + Scala mix.</li>
</ul>
<p>This two-level structure allows us to organize the code based on a functional target
(production, tests) and on implementation details (language, tools).
Let’s leverage this.</p>
<h1 id="tips">Tips</h1>
<h2 id="srcsourcesetkotlin"><code>src/{sourceSet}/kotlin</code></h2>
<p>Storing Kotlin files in the Kotlin-specific directory sounds obvious
but a lot of projects are 100% Kotlin and store the source code
as Java. Take a look at
<a href="https://github.com/square/leakcanary/tree/825ac6242cde0a4c0488547d03e12a8df91a5f31/leakcanary-object-watcher/src">LeakCanary</a>,
<a href="https://github.com/romannurik/muzei/tree/ba24eb7dcca0490ee8540066c5f8fb51b9a219d9/main/src/main">Muzei</a>,
<a href="https://github.com/square/okhttp/tree/1b4cc4bb33996c8fdcdb67854a30aea3bec12ae6/okhttp/src/main">OkHttp</a>,
<a href="https://github.com/Tinder/Scarlet/tree/12bac927c6b4109e2b9c50040873b544a84a142c/scarlet-core/src">Scarlet</a>,
<a href="https://github.com/JakeWharton/timber/tree/10f0adce3921ad2929ddf2f3b7fecda2cf3148a5/timber/src/main">Timber</a>,
<a href="https://github.com/InflationX/ViewPump/tree/8dbefccc27dce258b391efa5adfb94ec5ebbbadd/viewpump/src/main">ViewPump</a>,
<a href="https://github.com/square/workflow/tree/3cec6d22c4d0ba6ef858e71338d8f68985443ce4/kotlin/workflow-core/src">Workflow</a>
and more. I see a number of reasons behind this.</p>
<ul>
<li>The Kotlin compiler supports mixing Java and Kotlin code,
so there is no punishment from the tooling.</li>
<li>Projects migrate from Java to Kotlin using the mixing and
forget to change the source set configuration.</li>
<li>The Gradle Android plugin requires additional configuration
which might be not trivial.</li>
</ul>
<p>To be honest, there is nothing outright wrong with mixing Java and Kotlin code.
It’s more accurate and expectable to store them separately.
Also, it might help with Java → Kotlin migration efforts — it’s easier to observe
that the Java directory is shrinking and the Kotlin one is growing than
running <a href="https://github.com/AlDanial/cloc"><code>cloc</code></a> all the time.</p>
<h2 id="srcsourcesetkotlinx"><code>src/{sourceSet}/kotlinX</code></h2>
<p>There is a common issue of organizing Kotlin extensions.
I’ve seen a lot of projects with the <code>Extensions.kt</code> garbage fire. When everything is in
a single file — it’s easier to overlook an extension and write a new one placed at&hellip;
<code>extensions/Extensions.kt</code>. Guess what happens next.</p>
<p>I suggest storing extensions using the target class package and file names.
Plus — move them to the <code>kotlinX/</code> directory
as a separation of the project code from additions to the external one. This approach leads
to a better separation of concerns.</p>
<p>For example, the following <code>io.reactivex.functions.Consumer</code> extension should be placed at
<code>src/main/kotlinX/io/reactivex/functions/Consumer.kt</code>.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="line"><span class="cl"><span class="k">package</span> <span class="nn">io.reactivex.functions</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">fun</span> <span class="nf">Consumer</span><span class="p">&lt;</span><span class="n">Unit</span><span class="p">&gt;.</span><span class="n">asAction</span><span class="p">()</span> <span class="p">=</span> <span class="n">Action</span> <span class="p">{</span> <span class="n">accept</span><span class="p">(</span><span class="n">Unit</span><span class="p">)</span> <span class="p">}</span>
</span></span></code></pre></div><p>Bonus — imports start to make sense.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-diff" data-lang="diff"><span class="line"><span class="cl"><span class="gd">- import hello.there.asAction
</span></span></span><span class="line"><span class="cl"><span class="gd"></span><span class="gi">+ import io.reactivex.functions.asAction
</span></span></span></code></pre></div><h2 id="srctestfixtureskotlin"><code>src/testFixtures/kotlin</code></h2>
<p>A growing test / specification suite might be not pleasant to look at.
<a href="https://arturdryomov.dev/posts/superior-testing-make-fakes-not-mocks/">Using fakes</a>
is great but there is a possibility of having a huge file tree with mixed
tests and fakes.</p>
<pre tabindex="0"><code>.
└── src
    └── test
        └── kotlin
            ├── ApplicationSpec.kt
            ├── FakeApplication.kt
            ├── FakePermissions.kt
            └── PermissionsSpec.kt
</code></pre><p>Since fakes and tests are different things — I suggest to split them
in the digital world as well.</p>
<pre tabindex="0"><code>.
└── src
    ├── test
    │   └── kotlin
    │       ├── ApplicationSpec.kt
    │       └── PermissionsSpec.kt
    └── testFixtures
        └── kotlin
            ├── FakeApplication.kt
            └── FakePermissions.kt
</code></pre><p>In fact, <a href="https://docs.gradle.org/current/userguide/java_testing.html#sec:java_test_fixtures">Gradle supports this approach for the Java code</a>
and with benefits — it’s possible to share <code>testFixtures</code> across modules.
However, it doesn’t work with Gradle <a href="https://youtrack.jetbrains.com/issue/KT-33877">Kotlin</a>
and <a href="https://issuetracker.google.com/issues/139438142">Android</a> plugins.</p>
<h1 id="gradle-api">Gradle API</h1>
<p>The code below will use the Gradle Kotlin DSL but it can be adapted to the Groovy DSL as well.
The code was run against Gradle 6.1.1, Gradle Kotlin plugin 1.3.61 and Gradle Android plugin 3.5.3.</p>
<h2 id="jvm">JVM</h2>
<p>Gradle uses a couple of classes as an API to configure the source code location:</p>
<ul>
<li><code>SourceDirectorySet</code> — a set of source code files;</li>
<li><code>SourceSet</code> — a group of <code>SourceDirectorySet</code>s for Java code and resources.</li>
</ul>
<p>The Gradle Kotlin for JVM plugin adds another one.</p>
<ul>
<li><code>KotlinSourceSet</code> — like <code>SourceSet</code>, but for Kotlin sources.
Bonus — it configures <code>src/main/kotlin</code> and <code>src/test/kotlin</code> automatically.</li>
</ul>
<p>The DSL works with those classes.</p>
<ul>
<li>
<p>Single module (put in the module <code>build.gradle.kts</code> file).</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="line"><span class="cl"><span class="k">import</span> <span class="nn">org.jetbrains.kotlin.gradle.plugin.KotlinSourceSet</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Get a SourceSet collection
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">sourceSets</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Get a SourceSet by name
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">named</span><span class="p">(</span><span class="s2">&#34;source set name&#34;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Resolve a KotlinSourceSet
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">withConvention</span><span class="p">(</span><span class="n">KotlinSourceSet</span><span class="o">::</span><span class="k">class</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// Configure Kotlin SourceDirectorySet
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">kotlin</span><span class="p">.</span><span class="n">srcDirs</span><span class="p">(</span><span class="s2">&#34;path A&#34;</span><span class="p">,</span> <span class="s2">&#34;path B&#34;</span><span class="p">,</span> <span class="s2">&#34;path C&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></li>
<li>
<p>Multiple modules (put in the root <code>build.gradle.kts</code> file).</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="line"><span class="cl"><span class="k">import</span> <span class="nn">org.jetbrains.kotlin.gradle.plugin.KotlinSourceSet</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">subprojects</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// The sourceSets function is not available at root so we use a different syntax
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">configure</span><span class="p">&lt;</span><span class="n">SourceSetContainer</span><span class="p">&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">named</span><span class="p">(</span><span class="s2">&#34;source set name&#34;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">withConvention</span><span class="p">(</span><span class="n">KotlinSourceSet</span><span class="o">::</span><span class="k">class</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">kotlin</span><span class="p">.</span><span class="n">srcDirs</span><span class="p">(</span><span class="s2">&#34;path A&#34;</span><span class="p">,</span> <span class="s2">&#34;path B&#34;</span><span class="p">,</span> <span class="s2">&#34;path C&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></li>
</ul>
<h2 id="android">Android</h2>
<p>Gradle Android plugin ignores native Gradle source set infrastructure and introduces its own.
To be fair, the Android API tries to mimic the Gradle one, so I suspect
the reinvention was done for a reason.</p>
<ul>
<li><code>AndroidSourceDirectorySet</code> (mimics Gradle <code>SourceDirectorySet</code>) —
a set of source code files;</li>
<li><code>AndroidSourceSet</code> (mimics Gradle <code>SourceSet</code>) —
a group of <code>AndroidSourceDirectorySet</code>s for Java code and resources,
Android resources, assets, AIDL, RenderScript files and more.</li>
</ul>
<p>The Gradle Kotlin for Android plugin doesn’t provide a <code>KotlinAndroidSourceSet</code>
(like <code>KotlinSourceSet</code> for JVM). Fortunately enough we can use the Java <code>AndroidSourceSet</code> instead
(thanks to mixing).</p>
<p>The DSL is similar to the JVM one.</p>
<ul>
<li>
<p>Single module (put in the module <code>build.gradle.kts</code> file).</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="line"><span class="cl"><span class="n">android</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Get an AndroidSourceSet collection
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">sourceSets</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Get an AndroidSourceSet by name
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">named</span><span class="p">(</span><span class="s2">&#34;source set name&#34;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// Configure Java AndroidSourceDirectorySet
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">java</span><span class="p">.</span><span class="n">srcDirs</span><span class="p">(</span><span class="s2">&#34;path A&#34;</span><span class="p">,</span> <span class="s2">&#34;path B&#34;</span><span class="p">,</span> <span class="s2">&#34;path C&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></li>
<li>
<p>Multiple modules (put in the root <code>build.gradle.kts</code> file).</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="line"><span class="cl"><span class="k">import</span> <span class="nn">com.android.build.gradle.AppPlugin</span>
</span></span><span class="line"><span class="cl"><span class="k">import</span> <span class="nn">com.android.build.gradle.BaseExtension</span>
</span></span><span class="line"><span class="cl"><span class="k">import</span> <span class="nn">com.android.build.gradle.LibraryPlugin</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">subprojects</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Since the API comes from a plugin we have to wait for it
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">plugins</span><span class="p">.</span><span class="n">matching</span> <span class="p">{</span> <span class="k">it</span> <span class="k">is</span> <span class="n">AppPlugin</span> <span class="o">||</span> <span class="k">it</span> <span class="k">is</span> <span class="n">LibraryPlugin</span> <span class="p">}.</span><span class="n">whenPluginAdded</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// The android function is not available at root so we use a different syntax
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">configure</span><span class="p">&lt;</span><span class="n">BaseExtension</span><span class="p">&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">sourceSets</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">named</span><span class="p">(</span><span class="s2">&#34;source set name&#34;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">java</span><span class="p">.</span><span class="n">srcDirs</span><span class="p">(</span><span class="s2">&#34;path A&#34;</span><span class="p">,</span> <span class="s2">&#34;path B&#34;</span><span class="p">,</span> <span class="s2">&#34;path C&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></li>
</ul>
<h1 id="gradle-implementation">Gradle Implementation</h1>
<p>Nice, we can use the Gradle API to apply our tips!
Snippets below are DSL declarations that can be used in both single and multiple module
configurations described above.</p>
<h2 id="jvm-1">JVM</h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="line"><span class="cl"><span class="n">named</span><span class="p">(</span><span class="s2">&#34;main&#34;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">withConvention</span><span class="p">(</span><span class="n">KotlinSourceSet</span><span class="o">::</span><span class="k">class</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Gradle Kotlin for JVM plugin configures &#34;src/main/kotlin&#34; on its own
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">kotlin</span><span class="p">.</span><span class="n">srcDirs</span><span class="p">(</span><span class="s2">&#34;src/main/kotlinX&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">named</span><span class="p">(</span><span class="s2">&#34;test&#34;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">withConvention</span><span class="p">(</span><span class="n">KotlinSourceSet</span><span class="o">::</span><span class="k">class</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Gradle Kotlin for JVM plugin configures &#34;src/test/kotlin&#34; on its own
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">kotlin</span><span class="p">.</span><span class="n">srcDirs</span><span class="p">(</span><span class="s2">&#34;src/test/kotlinX&#34;</span><span class="p">,</span> <span class="s2">&#34;src/testFixtures/kotlin&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h2 id="android-1">Android</h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="line"><span class="cl"><span class="n">named</span><span class="p">(</span><span class="s2">&#34;main&#34;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">java</span><span class="p">.</span><span class="n">srcDirs</span><span class="p">(</span><span class="s2">&#34;src/main/kotlin&#34;</span><span class="p">,</span> <span class="s2">&#34;src/main/kotlinX&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">named</span><span class="p">(</span><span class="s2">&#34;test&#34;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">java</span><span class="p">.</span><span class="n">srcDirs</span><span class="p">(</span><span class="s2">&#34;src/test/kotlin&#34;</span><span class="p">,</span> <span class="s2">&#34;src/test/kotlinX&#34;</span><span class="p">,</span> <span class="s2">&#34;src/testFixtures/kotlin&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h1 id="next">Next?</h1>
<p>Don’t afraid to configure source sets — think about what can be done better
and adapt. The Gradle API might be not intuitive at first glance —
especially when Kotlin and Android are brought in the mix — but almost everything can be achieved.</p>

</main>


<hr/>

<footer>
<nav>
  <ul>
    
    <li class="menu-left"><a href="/">Posts</a></li>
    
    
    <li class="menu-right"><a href="/index.xml">RSS</a></li>
    
    <li class="menu-right"><a href="https://github.com/arturdryomov">GitHub</a></li>
    
  </ul>
</nav>

</footer>


</body>

</html>

